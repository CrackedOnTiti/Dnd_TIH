<!DOCTYPE html>
<html>
<head>
    <title>Player</title>
</head>
<body>
    <h1>Player: <span id="playerName"></span></h1>

    <p><strong>Power:</strong> <span id="power"></span></p>
    <p><strong>Power Description:</strong> <span id="powerDescription"></span></p>
    <p><strong>Sex:</strong> <span id="sex"></span></p>
    <p><strong>Physical Description:</strong> <span id="physicalDescription"></span></p>

    <hr>

    <p><strong>HP:</strong> <span id="currHp"></span> / <span id="maxHp"></span></p>

    <hr>

    <p><strong>Last Roll:</strong> <span id="lastRoll">0</span></p>

    <label>Dice Type:</label>
    <select id="diceType">
        <option value="5">d5</option>
        <option value="10">d10</option>
        <option value="20" selected>d20</option>
        <option value="100">d100</option>
    </select>
    <button onclick="rollDice()">Roll Dice</button>

    <hr>

    <button onclick="logout()">Logout</button>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // Check if player ID exists
        const playerId = localStorage.getItem('playerId');
        if (!playerId) {
            window.location.href = '/';
        }

        // Load player data from database
        async function loadPlayerData() {
            const response = await fetch(`/api/player/${playerId}`);
            const result = await response.json();

            if (result.success) {
                const player = result.player;
                document.getElementById('playerName').textContent = player.player_name;
                document.getElementById('power').textContent = player.power;
                document.getElementById('powerDescription').textContent = player.power_description;
                document.getElementById('sex').textContent = player.sex;
                document.getElementById('physicalDescription').textContent = player.physical_description;
                document.getElementById('currHp').textContent = player.curr_hp;
                document.getElementById('maxHp').textContent = player.max_hp;
                document.getElementById('lastRoll').textContent = player.last_dice_roll;
            } else {
                alert('Error loading player data');
                window.location.href = '/';
            }
        }

        function logout() {
            localStorage.removeItem('playerId');
            window.location.href = '/';
        }

        async function rollDice() {
            const diceType = parseInt(document.getElementById('diceType').value);
            const roll = Math.floor(Math.random() * diceType) + 1;

            // Update display immediately
            document.getElementById('lastRoll').textContent = roll;

            // Save to database
            const response = await fetch(`/api/player/${playerId}/roll`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ roll: roll })
            });

            const result = await response.json();
            if (!result.success) {
                alert('Error saving dice roll');
            }
        }

        // Load data on page load
        loadPlayerData();

        // Socket connection
        const socket = io();

        socket.on('connect', () => {
            console.log('Connected to server');
        });
    </script>
</body>
</html>
